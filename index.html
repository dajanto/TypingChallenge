<!DOCTYPE html>
  <head lang="de">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>dajantos Typing Challenge</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
   
 <script type="text/javascript">
    
    // Field declarations and initializations.
    var _wordsAllArray = new Array();
 	var _wordAsString = new String();
    var _counter = 61;
    var _t;
    var _isTimerOn = false;
    var _rightWords = [];
	var _wrongWords = [];
	var _rightKeystrokes = 0;
   	var _wrongKeystrokes = 0;

   	/*
   		Fills the Word Array with all words that are involved to the challenge.
   	*/
 	function fillWordArrayWithWords() {
 		_wordsAllArray = ["allein","alles","also","am","auch",
							"auf","aus","bald","dann","darauf",
							"dass","dem","den","denn","deren",
							"die","diese","dieser","doch","einem",
							"eines","einen","einmal","einer","er",
							"sie","es", "wir", "ihr", "sie",
							"ganz", "ganze", "gar", "gut", "Hand",
							"gemacht", "hätte", "hätten", "trotzdem",
							"hier", "ihn", "ihr", "ihrem", "im",
							"ist", "ja", "nein", "Jahre", "jetzt",
							"keine", "können", "lange", "Leben", "Liebe",
							"mehr", "meiner", "Menschen", "nur", "oder",
							"recht", "schon", "sehen", "sehr", "sein",
							"seiner", "sind", "sollte", "um", "vielleicht",
							"vom", "waren", "weiter", "welche", "welcher",
							"welches", "werde", "werden", "worden", "wohl",
							"zwar", "zwischen", "hatte", "war", "ersten",
							"Herr", "Welt", "damit", "sagen", "unter", 
							"diesen", "dieses", "heute", "gegeben", "Seite",
							"Weise", "gewesen", "einzelnen", "nun", "ihm",
							"mir", "kommen", "während", "seinen", "seinem",
							"deinen", "schlecht"];				
    }

	/*
		A simple countdown. If the countdown hits 0 seconds timer is stopped, 
		typing field disabled and score will be showing up.
	*/
    function countdown() {
		
		_counter--;
		_t = setTimeout("countdown()", 1000);
		getTimerTextfield().value = _counter;

		if(_counter == 0) {
			isTimerOn = false;
  			clearTimeout(_t);
  			getTypingTextfield().disabled=true;
  			getTypingTextfield().value = ""
  			calculateScores();
		}
	}

	/*
		Starts the countdown if there is no timer running at the moment.
	*/
	function startCountdown() {
		if(!_isTimerOn) {
			_isTimerOn = true;
			countdown();
		}
	}

	/*
		Calculates the scores and displays it after the timer hits 0 seconds.
	*/
	function calculateScores() {

		var WPM = _rightWords.length;
		var rightWords = _rightWords.length;
		var wrongWords = _wrongWords.length;
		var rightKeystrokes = _rightKeystrokes;
		var wrongKeystrokes = _wrongKeystrokes;
		var officialWPM = Math.floor(rightKeystrokes/5);

		// Calculation of average word length
		// var avgWordLength = 0;
		// for (var i = 0; i < _wordsAllArray.length; i++) {
		// 	avgWordLength += _wordsAllArray[i].length;
		// }
		// avgWordLength = avgWordLength / _wordsAllArray.length;
		// alert(avgWordLength);
		getTimerTextfield().style.height="150px";
		getTimerTextfield().style.width="300px";

		getTimerTextfield().value = "*** S C O R E ***" + "\n"
			+ "Right words: " + rightWords + " (" + rightKeystrokes + " keystrokes)" + "\n"
			+ "Wrong words: " + wrongWords + " (" + wrongKeystrokes + " keystrokes)" + "\n"
			+ "Actual WPM: " + WPM + " (" + (rightKeystrokes+wrongKeystrokes) + " keystrokes)" + "\n"
			+ "Offical WPM*: " + officialWPM + " (" + (rightKeystrokes+wrongKeystrokes) + " keystrokes)" + "\n" + "\n"
			+ "*Keystrokes / 5 (Average word length)";
	}

	/*
		Deletes viewable content of the Typing Textfield as well as the Problem Textfield.
	*/
	function cleanUpFrontend() {
		document.getElementById("typingTextfield").value = "";
		document.getElementById("problemTextfield").value = "";
	}

	/*
		Deletes unviewable content of the Typing Textfield as well as the Problem Textfield.
	*/
    function cleanUpBackend() {
    	_wordAsString = "";
    	_wordsAllArray = [];
    }

    /*
    	Shuffles an given Array.
    */
    function shuffle(array) {
	    
	    var j, x, i;
	    
	    for (i = array.length; i; i -= 1) {
	        j = Math.floor(Math.random() * i);
	        x = array[i - 1];
	        array[i - 1] = array[j];
	        array[j] = x;
	    }
}
	/*
		Shuffles the Word Array and generating a string with words that can be displayed. 
	*/
    function generateProblem() {
    	
    	cleanUpBackend();
 		fillWordArrayWithWords();
 		shuffle(_wordsAllArray);
 
 		for (var i = 0 ; i < _wordsAllArray.length; i++) {
    		_wordAsString = _wordAsString + _wordsAllArray[i] + " ";
    	}

    	_wordAsString += _wordAsString;
    	_wordAsString += _wordAsString;
    	_wordAsString.trim();
 	}

	/*
		Uses the string to display the problem.
 	*/
 	function displayProblem() {
 		cleanUpFrontend();
 		document.getElementById("problemTextfield").value = _wordAsString;
 	}

	/*
		Returns the Typing Textfield.
 	*/
 	function getTypingTextfield() {
 		return document.getElementById("typingTextfield");
 	}

	/*
		Returns the Problem Textfield.
 	*/
 	function getProblemTextfield() {
 		return document.getElementById("problemTextfield");
 	}

	/*
		Returns the body of the HTML document.	
 	*/
 	function getBody() {
 		return document.getElementsByTagName("BODY")[0];
 	}

	/*
		Returns the Timer Textfield.
 	*/
 	function getTimerTextfield() {
 		return document.getElementById("timerTextfield");
 	}

	/*
		Returns the Refresh Button.
 	*/
 	function getRefreshWordsButton() {
 		return document.getElementById("refreshButton");
 	}

   </script>
  </head>
  <body onLoad="getRefreshWordsButton().click();" background="forest.jpg"> 	
  	<center><font size="6" color="white">typing challenge by dajanto</font></center>
	<div class="section group" align="center">
	<div class="col span_1_of_3" align="center">
	<textarea style="resize:none; overflow: hidden; width: 300px; height: 48px;" class="form-control" readonly wrap="soft" rows="2" cols="2" id="problemTextfield"></textarea>
	</div>
	<textarea style="resize:none; overflow: hidden; width: 45px; height: 30px;" class="form-control" readonly rows="2" cols="2" id="timerTextfield"></textarea>
	<div class="col span_1_of_3" align="center">
	<textarea autofocus style="resize:none; overflow: hidden; width: 300px; height: 30px;" class="form-control" id="typingTextfield" rows="1" cols="2" placeholder="Start typing to begin a challenge."></textarea>
	<script> {



		// This happens if a keyboard key has been pressed.
		getTypingTextfield().addEventListener("keypress", function checkKeyPress(e) {
    		
    		if(getProblemTextfield().value !== "") {
    			startCountdown();
    			getTypingTextfield().placeholder= "";
    		}

			var array = _wordAsString.trim().split(" "); 
			var firstWordOfString = array[0];

				var SPACE = 32;

    			if (e.keyCode == SPACE) {
    				e.preventDefault();
    				
    				if(getTypingTextfield().value !== "") {
    					if(firstWordOfString === getTypingTextfield().value) {
     						_rightWords.push(firstWordOfString);
     						_rightKeystrokes += firstWordOfString.length;
     					} 
     					else if(firstWordOfString !== getTypingTextfield().value) {
     						_wrongWords.push(firstWordOfString);
     						_wrongKeystrokes += firstWordOfString.length;
     					}
    				}
					getTypingTextfield().value = "";
					_wordAsString = _wordAsString.substring(firstWordOfString.length + 1,_wordAsString.length);
     				getProblemTextfield().value = _wordAsString; 
    				getBody().style.backgroundColor = "white";
				}
			});

		// This happens if a keyboard key goes up.
		getTypingTextfield().addEventListener("keyup", function checkKeyUp(e) {
			
			var array = _wordAsString.trim().split(" "); 
			var firstWordOfString = array[0];

			// Colorful typing characterwise (TODO)
			if(getTypingTextfield().value === firstWordOfString.substring(0,getTypingTextfield().value.length)) {
					
					// _wordAsString = firstWordOfString.substring(0,getTypingTextfield().value.length).fontcolor("green") + _wordAsString.substring(getTypingTextfield().value.length,_wordAsString.length);
					getProblemTextfield().style.backgroundColor = "#d5ffd5";
				}
				else {
					
					// _wordAsString = firstWordOfString.substring(0,getTypingTextfield().value.length).fontcolor("red") + _wordAsString.substring(getTypingTextfield().value.length,_wordAsString.length);
					getProblemTextfield().style.backgroundColor = "#ffdddd";
				}
				// getProblemTextfield().value = _wordAsString; 
		});
	}



	</script>
	</div>
	<div class="col span_1_of_3" align="center">
  	<button name="Refresh button" id="refreshButton" type="button" class="btn btn-primary" onclick="gettingReadyToPlay()">Refresh words</button>
  	<script>
  	
  	/*
  		This is the method that is called everytime the Refresh button has been pressed.
  		It's mostly about cleaning up stuff that another challenge can be launched. 
  	*/
  	function gettingReadyToPlay() {
		
		document.body.style.zoom="250%";

  		getBody().style.backgroundRepeat = "repeat";

		getTypingTextfield().disabled= false;
  		_counter = 61;
		_isTimerOn = false;
  		clearTimeout(_t);
  		getTimerTextfield().value = "";
  		getTypingTextfield().placeholder="Start typing to begin a challenge.";

  		getTimerTextfield().style.textAlign="center";
  		getTypingTextfield().style.textAlign="center";
  		getTimerTextfield().style.height="30px";
  		getTimerTextfield().style.width="45px";

  		_rightWords = [];
  		_wrongWords = [];
  		_rightKeystrokes = 0;
  		_wrongKeystrokes = 0;

		problemTextfield.style.backgroundColor="white";
  		
  		cleanUpFrontend();
  		generateProblem();
  		displayProblem();
  	}

  	</script>
  </body>
</html>